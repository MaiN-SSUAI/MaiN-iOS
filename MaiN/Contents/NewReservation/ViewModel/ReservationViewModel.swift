//
//  ReservationViewModel.swift
//  MaiN
//
//  Created by ÍπÄÏàòÎØº on 5/20/24.
//

import SwiftUI
import Moya

class ReservationViewModel: ObservableObject {
    //MARK: data
    @Published var reservations: [Reservation] = [Reservation(reservId: 16,
                                                              studentNo: ["20221813", "20220900"], purpose: "dummy data",
                                                              start: "2024-05-25T01:00:00.000+09:00", end: "2024-05-25T02:00:00.000+09:00",
                                                              start_pixel: "36", end_pixel: "72"),
                                                Reservation(reservId: 0,
                                                            studentNo: ["20233107"], purpose: "",
                                                            start: "2024-06-03T13:00:00.000+09:00", end: "2024-06-03T16:00:00.000+09:00",
                                                            start_pixel: "468", end_pixel: "576")]
    
    @Published var weekReservations: [[Reservation]] = [
            [Reservation(reservId: 16,
                         studentNo: ["20221813", "20220900"], purpose: "",
            start: "2024-05-25T01:00:00.000+09:00",
            end: "2024-05-25T02:00:00.000+09:00",
            start_pixel: "36", end_pixel: "72"),
             Reservation(reservId: 16,
                         studentNo: ["20221813", "20220900"], purpose: "",
             start: "2024-05-25T02:10:00.000+09:00",
             end: "2024-05-25T03:00:00.000+09:00",
             start_pixel: "36", end_pixel: "72")],
            [Reservation(reservId: 16,
                         studentNo: ["20221813", "20220900"], purpose: "",
            start: "2024-05-25T04:00:00.000+09:00",
            end: "2024-05-25T05:00:00.000+09:00",
            start_pixel: "36", end_pixel: "72")],
            [Reservation(reservId: 16,
                         studentNo: ["20221813", "20220900"], purpose: "",
            start: "2024-05-25T04:00:00.000+09:00",
            end: "2024-05-25T05:00:00.000+09:00",
            start_pixel: "36", end_pixel: "72")],
            [Reservation(reservId: 16,
                         studentNo: ["20221813", "20220900"], purpose: "",
            start: "2024-05-25T04:00:00.000+09:00",
            end: "2024-05-25T05:00:00.000+09:00",
            start_pixel: "36", end_pixel: "72")],
            [Reservation(reservId: 16,
                         studentNo: ["20221813", "20220900"], purpose: "",
            start: "2024-05-25T04:00:00.000+09:00",
            end: "2024-05-25T05:00:00.000+09:00",
            start_pixel: "36", end_pixel: "72")],
            [Reservation(reservId: 16,
                         studentNo: ["20221813", "20220900"], purpose: "",
            start: "2024-05-25T04:00:00.000+09:00",
            end: "2024-05-25T05:00:00.000+09:00",
            start_pixel: "36", end_pixel: "72")],
            [Reservation(reservId: 16,
                         studentNo: ["20221813", "20220900"], purpose: "",
            start: "2024-05-25T04:00:00.000+09:00",
            end: "2024-05-25T05:00:00.000+09:00",
                         start_pixel: "36", end_pixel: "72")]] {
         didSet {
             if (weekReservations.allSatisfy { $0.isEmpty }) {reservations = []} else {
                 reservations = weekReservations[selectedDateIndex]
             }
         }
     }
    
    @Published var selectedDetailReservInfo: ReservDetailInfo = ReservDetailInfo(reservId: 0, studentIds: [], purpose: "", time: "")
    
    //MARK: View
    @Published var isInfoModalPresented: Bool = false
    @Published var isDetailModalPresented: Bool = false
    @Published var isRegisterModalPresented: Bool = false {
        didSet {
            print("Îì±Î°ù Î™®Îã¨ :\(isRegisterModalPresented)")
        }
    }
    @Published var selectedDate: Date = Date() {
        didSet {
            updateSelectedDateIndex()
        }
    }
    @Published var selectedDateIndex: Int = 0 {
        didSet {
            if weekReservations.allSatisfy { $0.isEmpty } {
                reservations = []
            } else {
                reservations = weekReservations[selectedDateIndex]
            }
        }
    }
    @Published var dayOrWeek: String = "day"
    @Published var selectedReservation: Reservation?
    @Published var alertMessage: String? = nil
    @Published var showAlert: Bool = false
    
    //MARK: Network
    @Published var isLoading: Bool = false // API Ìò∏Ï∂ú ÏßÑÌñâÏ§ë
    @Published var isWeekLoading: Bool = false // API Ìò∏Ï∂ú ÏßÑÌñâÏ§ë
    @Published var trigger: Bool = false { // API Í∞ïÏ†ú Ìò∏Ï∂ú
        didSet {
            print("‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏ètriggerÏûëÎèô")
            fetchWeekReservationAPI(for: selectedDate)
        }
    }
    //MARK: User
    @EnvironmentObject var logInVM: LogInViewModel
    
    //MARK: init
    init() {

            let authPlugin = AuthPlugin()
            authPlugin.onRetrySuccess = { [weak self] in
                self?.fetchReservationAPI(for: self?.selectedDate ?? Date())
                self?.fetchWeekReservationAPI(for: self?.selectedDate ?? Date())
            }
            self.provider = MoyaProvider<NewReservationAPI>(plugins: [authPlugin])
            fetchReservationAPI(for: selectedDate)
            fetchWeekReservationAPI(for: selectedDate)
            updateSelectedDateIndex()
        }

    private func updateSelectedDateIndex() {
        let calendar = Calendar.current
        let weekday = calendar.component(.weekday, from: selectedDate)
        
        switch weekday {
        case 1: // Sunday
            selectedDateIndex = 6
        case 2: // Monday
            selectedDateIndex = 0
        case 3: // Tuesday
            selectedDateIndex = 1
        case 4: // Wednesday
            selectedDateIndex = 2
        case 5: // Thursday
            selectedDateIndex = 3
        case 6: // Friday
            selectedDateIndex = 4
        case 7: // Saturday
            selectedDateIndex = 5
        default:
            selectedDateIndex = -1 // Error case, should not happen
        }
    }
    
    func showInfoModal() {
        isInfoModalPresented = true
    }
    
    func changeDate(date: Date) {
        selectedDate = date
    }
    
    //MARK: Network
    var provider = MoyaProvider<NewReservationAPI>()
    
    func fetchReservationAPI(for date: Date) {
        self.isLoading = true
        provider.request(.getReservation(date: date.toDateString())) { result in
            switch result {
            case let .success(response):
                print(response)
                if let reservations = try? response.map([Reservation?].self) {
                    print("ÏÑ∏ÎØ∏ÎÇòÏã§ Îß§Ìïë ÏÑ±Í≥µüö®")
                    print("üå∑accessToekn:\(TokenManager.shared.accessToken)")
                    print("üå∑refreshToekn:\(TokenManager.shared.refreshToken)")
                    self.reservations = reservations.compactMap { $0 }
                } else {
                    print("ÏÑ∏ÎØ∏ÎÇòÏã§ Îß§Ìïë Ïã§Ìå®üö®")
                    print("üå∑accessToekn:\(TokenManager.shared.accessToken)")
                    print("üå∑refreshToekn:\(TokenManager.shared.refreshToken)")
                }
            case .failure:
                print("ÏÑ∏ÎØ∏ÎÇòÏã§ ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠ Ïã§Ìå®üö®")
            }
            self.isLoading = false
        }
    }
    
    func fetchWeekReservationAPI(for date: Date) {
        self.isWeekLoading = true
        self.isLoading = true
        provider.request(.getWeekReservation(date: date.toDateString())) { result in
            switch result {
            case let .success(response):
                print(response)
                do {
                    let decodedData = try JSONDecoder().decode(WeekReservations.self, from: response.data)
                    self.weekReservations = [
                        decodedData.Mon,
                        decodedData.Tue,
                        decodedData.Wed,
                        decodedData.Thu,
                        decodedData.Fri,
                        decodedData.Sat,
                        decodedData.Sun
                    ]
                    print("week ÏÑ∏ÎØ∏ÎÇòÏã§ Îß§Ìïë ÏÑ±Í≥µüö®")
                } catch {
                    print("week ÏÑ∏ÎØ∏ÎÇòÏã§ Îß§Ìïë Ïã§Ìå®üö®: \(error)")
                    self.weekReservations = [[]]
                    if self.dayOrWeek == "day" {
                        self.fetchReservationAPI(for: self.selectedDate)
                    }
                }
            case .failure:
                self.weekReservations = [[]]
                print("ÏÑ∏ÎØ∏ÎÇòÏã§ ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠ Ïã§Ìå®üö®")
                if self.dayOrWeek == "week" {
                    self.alertMessage = "ÎÑ§Ìä∏ÏõåÌÅ¨ ÏóêÎü¨"
                    self.showAlert = true
                } else {
                    self.fetchReservationAPI(for: self.selectedDate)
                }
            }
            self.isWeekLoading = false
            self.isLoading = false
        }
    }
    
    func addReservation(reservInfo: ReservInfo, completion: @escaping (String) -> Void) {
        self.isLoading = true
        self.isWeekLoading = true
        print("ÏûêÍ≥†Ïã∂Îã§:\(reservInfo.startDateTimeStr), \(reservInfo.endDateTimeStr)")
        provider.request(.addReservation(reserv: reservInfo)) { result in
            switch result {
            case .success(let response):
                let statusCode = response.statusCode
                if statusCode == 200 {
                    if let responseString = String(data: response.data, encoding: .utf8) {
                            print("ÏÑ∏ÎØ∏ÎÇòÏã§ ÏòàÏïΩ Îì±Î°ù API ÏÑ±Í≥µüî• : \(responseString)")
                            completion("ÏòàÏïΩÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.")
                    }
                } else if statusCode == 400 {
                    if let responseData = try? JSONDecoder().decode(ErrorResponse.self, from: response.data) {
                        let errorMessage = responseData.detail
                        print("ÏÑ∏ÎØ∏ÎÇòÏã§ ÏòàÏïΩ Îì±Î°ù API Ïã§Ìå®üî• - ÏÉÅÌÉú ÏΩîÎìú: \(statusCode) Î©îÏãúÏßÄ: \(errorMessage)")
                        completion("\(errorMessage)")
                    } else {
                        print("ÏÑ∏ÎØ∏ÎÇòÏã§ ÏòàÏïΩ Îì±Î°ù API Ïã§Ìå®üî• - ÏÉÅÌÉú ÏΩîÎìú: \(statusCode)")
                        completion("ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠Ïù¥ Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.")
                    }
                } else {
                    completion("ÌÜ†ÌÅ∞ ÎßåÎ£å")
                }
            case .failure(let error):
                print("ÏÑ∏ÎØ∏ÎÇòÏã§ ÏòàÏïΩ Îì±Î°ù API Ïã§Ìå®üî• : \(error)")
                completion("ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠Ïù¥ Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.")
            }
//            self.isLoading = false
//            self.isWeekLoading = false
        }
    }

    
    func deleteReservation(reservId: Int, completion: @escaping (String) -> Void) {
        self.isLoading = true
        self.isWeekLoading = true
        provider.request(.deleteReservation(reservId: reservId)) { result in
            switch result {
            case .success(let response):
                if response.statusCode == 401 {
                    completion("ÌÜ†ÌÅ∞ ÎßåÎ£å")
                } else if response.statusCode == 400 {
                    if let responseData = try? JSONDecoder().decode(ErrorResponse.self, from: response.data) {
                        let errorMessage = responseData.detail
                        completion("\(errorMessage)")} else {
                            completion("ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠Ïù¥ Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.")
                        }
                } else {
                    print("ÏÑ∏ÎØ∏ÎÇòÏã§ ÏòàÏïΩ ÏÇ≠Ï†ú API ÏÑ±Í≥µüî•")
                    completion("ÏòàÏïΩÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.")
                }
            case .failure(let error):
                print("ÏÑ∏ÎØ∏ÎÇòÏã§ ÏòàÏïΩ ÏÇ≠Ï†ú API Ïã§Ìå®üî•: \(error)")
                completion("ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠Ïù¥ Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§")
            }
//            self.isLoading = false
//            self.isWeekLoading = false
        }
    }
    
    func checkUser(user: String, date: String, completion: @escaping (String) -> Void) {
        provider.request(.checkUser(user: user, date: date)) { result in
            switch result {
            case .success(let response):
                let statusCode = response.statusCode
                if statusCode == 200 {
                    print("üíöcheckUser API ÏÑ±Í≥µ")
                    completion("ÏÑ±Í≥µ")
                } else if statusCode == 400 {
                    if let responseData = try? JSONDecoder().decode(ErrorResponse.self, from: response.data) {
                        let errorMessage = responseData.detail
                        print("üíöcheckUser API Ïã§Ìå®1")
                        completion("\(errorMessage)")
                    } else {
                        print("üíöcheckUser API ÏòµÏÖîÎÑê Ïã§Ìå®2")
                        completion("ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠Ïù¥ Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.")
                    }
                } else {
                    print("üíöcheckUser API Ïã§Ìå®3")
                    completion("ÌÜ†ÌÅ∞ ÎßåÎ£å")
                }
            case .failure(let error):
                print("üíöcheckUser API Ïã§Ìå®4")
                completion("ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠Ïù¥ Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.")
            }
        }
    }
}

struct ReservInfo: Codable, Hashable {
    let studentIds: [String]
    let purpose: String
    let startDateTimeStr: String
    let endDateTimeStr: String
}

struct ErrorResponse: Decodable {
    let message: String
    let code: String
    let status: Int
    let detail: String
}
